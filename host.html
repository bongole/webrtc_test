<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
</head>
<body>
  <video id="my-video" width="400px" autoplay muted playsinline></video>
  <p id="my-id"></p>
  <video id="their-video" width="400px" autoplay playsinline></video>
  <button id="record-start">Record start</button>
  <button id="record-stop">Record stop</button>
  <a id="record-download">Record download</a>
  <script>
     let localStream;
     let streams = [];

     // カメラ映像取得
     navigator.mediaDevices.getUserMedia({video: true, audio: true})
    .then( stream => {
       // 成功時にvideo要素にカメラ再生
       const videoElm = document.getElementById('my-video')
       videoElm.srcObject = stream;
       videoElm.play();
       localStream = stream;
       streams.push(stream);
     }).catch( error => {
       // 失敗時にはエラーログを出力
       console.error('mediaDevice.getUserMedia() error:', error);
       return;
     });
     
     const peer = new Peer({
       key: '8f4f58ac-ba7b-4ab6-bb0f-0e47e40c180f',
       debug: 3
     });

     peer.on('open', () => {
       document.getElementById('my-id').textContent = 'Peer ID: ' + peer.id;
     });

     // イベントリスナを設置する関数
     const setEventListener = mediaConnection => {
       mediaConnection.on('stream', stream => {
         streams.push(stream);
         // video要素にカメラ映像をセットして再生
         const videoElm = document.getElementById('their-video')
         videoElm.srcObject = stream;
         videoElm.play();
       });
     };

    //着信処理
    peer.on('call', mediaConnection => {
      console.log('answer')
      mediaConnection.answer(localStream);
      setEventListener(mediaConnection);
    });
       
    peer.on('error', err => {
          console.error(err.message);
    });

    let btnRecordStart = document.getElementById('record-start');
    let btnRecordStop = document.getElementById('record-stop');
    let btnRecordDownload = document.getElementById('record-download');

    let recorder;
    let chunks = [];
    btnRecordStart.addEventListener('click', (evt) => {
      const ac = new AudioContext();

      let audioTracks = streams.flatMap(stream => stream.getAudioTracks());
      console.log(audioTracks)

      // WebAudio MediaStream sources only use the first track.
      const sources = audioTracks.map(t => ac.createMediaStreamSource(new MediaStream([t])));

      // The destination will output one track of mixed audio.
      const dest = ac.createMediaStreamDestination();

      // Mixing
      sources.forEach(s => s.connect(dest));

      // Record 10s of mixed audio as an example
      recorder = new MediaRecorder(dest.stream);
      recorder.ondataavailable = (e) => {
        console.log("recorder got data");
        chunks.push(e.data);
      };
      recorder.onstop = () => console.log("recorder stopped");
      recorder.start(1000);
    });

    btnRecordStop.addEventListener('click', (e) => {
      if( recorder ){
        recorder.stop();
      }
    });

   btnRecordDownload.addEventListener('click', (e) => {
     const videoBlob = new Blob(chunks, { type: "audio/webm" });

     // 再生できるようにURLを生成
     blobUrl = window.URL.createObjectURL(videoBlob);

     // ==== (3) ====
     // ダウンロードの準備
     btnRecordDownload.download = 'recorded.webm';
     btnRecordDownload.href = blobUrl;
    });
  </script>
</body>
</html>
